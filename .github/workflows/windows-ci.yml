name: Windows CI

on:
  push:
    branches:
      - "**"
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "4.0.2"

      - name: Configure (Debug)
        run: cmake --preset vs2022-win32-debug

      - name: Build (Debug, all DLLs)
        run: cmake --build --preset vs2022-win32-debug-all

      - name: Configure (Release)
        run: cmake --preset vs2022-win32-release

      - name: Build (Release, all DLLs)
        run: cmake --build --preset vs2022-win32-release-all

  release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmakeVersion: "4.0.2"

      - name: Configure (Release)
        run: cmake --preset vs2022-win32-release

      - name: Build (Release, all DLLs)
        run: cmake --build --preset vs2022-win32-release-all

      - name: Package DLLs
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $buildDir = Join-Path $env:GITHUB_WORKSPACE "cmake-build-release-visual-studio/Release"
          $rootDir = $env:GITHUB_WORKSPACE
          $outDir = Join-Path $env:GITHUB_WORKSPACE "artifacts"
          New-Item -ItemType Directory -Path $outDir -Force | Out-Null
          $dlls = @(
            "imgui.dll",
            "SC4RenderServices.dll",
            "SC4ImGuiSample.dll",
            "SC4ImGuiSampleCity.dll",
            "SC4ImGuiSampleDemo.dll",
            "SC4ImGuiTextureSample.dll",
            "SC4WorldProjectionSample.dll",
            "SC4S3DCameraDebugSample.dll",
            "SC4OverlayManagerSample.dll",
            "SC4DrawServiceSample.dll",
            "SC4RoadDecalSample.dll"
          )
          $paths = $dlls | ForEach-Object { Join-Path $buildDir $_ }
          # Include the default INI config file
          $paths += Join-Path $rootDir "SC4RenderServices.ini"
          $archive = Join-Path $outDir ("sc4-render-services-" + "${{ github.ref_name }}" + "-win32-release.zip")
          Compress-Archive -Path $paths -DestinationPath $archive -Force

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
